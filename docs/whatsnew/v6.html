<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>New in Nutils 6 - The Nutils Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../about.html">About Nutils</a></li><li class="chapter-item "><a href="../intro.html"><strong aria-hidden="true">1.</strong> How to Read This Book</a></li><li class="chapter-item "><a href="../start.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li class="chapter-item "><a href="../install/intro.html"><strong aria-hidden="true">3.</strong> Installation</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../install/nutils.html"><strong aria-hidden="true">3.1.</strong> Installing Nutils</a></li><li class="chapter-item "><a href="../install/matrix.html"><strong aria-hidden="true">3.2.</strong> Installing a Matrix Backend</a></li><li class="chapter-item "><a href="../install/quality.html"><strong aria-hidden="true">3.3.</strong> Quality of Life</a></li><li class="chapter-item "><a href="../install/performance.html"><strong aria-hidden="true">3.4.</strong> Improving Performance</a></li><li class="chapter-item "><a href="../install/containers.html"><strong aria-hidden="true">3.5.</strong> Using Containers</a></li><li class="chapter-item "><a href="../install/remote.html"><strong aria-hidden="true">3.6.</strong> Remote Computing</a></li></ol></li><li class="chapter-item "><a href="../tutorial/intro.html"><strong aria-hidden="true">4.</strong> Tutorial</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tutorial/theory.html"><strong aria-hidden="true">4.1.</strong> A Little Bit of Theory</a></li><li class="chapter-item "><a href="../tutorial/topovgeom.html"><strong aria-hidden="true">4.2.</strong> Topology vs Geometry</a></li><li class="chapter-item "><a href="../tutorial/bases.html"><strong aria-hidden="true">4.3.</strong> Bases</a></li><li class="chapter-item "><a href="../tutorial/functions.html"><strong aria-hidden="true">4.4.</strong> Functions</a></li><li class="chapter-item "><a href="../tutorial/namespace.html"><strong aria-hidden="true">4.5.</strong> Namespace</a></li><li class="chapter-item "><a href="../tutorial/integrals.html"><strong aria-hidden="true">4.6.</strong> Integrals</a></li><li class="chapter-item "><a href="../tutorial/solvers.html"><strong aria-hidden="true">4.7.</strong> Solvers</a></li><li class="chapter-item "><a href="../tutorial/sampling.html"><strong aria-hidden="true">4.8.</strong> Sampling</a></li><li class="chapter-item "><a href="../tutorial/laplace2d.html"><strong aria-hidden="true">4.9.</strong> 2D Laplace Problem</a></li></ol></li><li class="chapter-item expanded "><a href="../whatsnew/intro.html"><strong aria-hidden="true">5.</strong> What's New</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../whatsnew/v7.html"><strong aria-hidden="true">5.1.</strong> New in Nutils 7</a></li><li class="chapter-item expanded "><a href="../whatsnew/v6.html" class="active"><strong aria-hidden="true">5.2.</strong> New in Nutils 6</a></li><li class="chapter-item "><a href="../whatsnew/v5.html"><strong aria-hidden="true">5.3.</strong> New in Nutils 5</a></li><li class="chapter-item "><a href="../whatsnew/v4.html"><strong aria-hidden="true">5.4.</strong> New in Nutils 4</a></li><li class="chapter-item "><a href="../whatsnew/v3.html"><strong aria-hidden="true">5.5.</strong> New in Nutils 3</a></li><li class="chapter-item "><a href="../whatsnew/v2.html"><strong aria-hidden="true">5.6.</strong> New in Nutils 2</a></li><li class="chapter-item "><a href="../whatsnew/v1.html"><strong aria-hidden="true">5.7.</strong> New in Nutils 1</a></li><li class="chapter-item "><a href="../whatsnew/v0.html"><strong aria-hidden="true">5.8.</strong> New in Nutils 0</a></li></ol></li><li class="chapter-item "><a href="../examples.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li class="chapter-item "><a href="../api.html"><strong aria-hidden="true">7.</strong> API Reference</a></li><li class="chapter-item "><a href="../support.html"><strong aria-hidden="true">8.</strong> Support</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Nutils Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/evalf/nutils" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="new-in-nutils-6-garak-guksu"><a class="header" href="#new-in-nutils-6-garak-guksu">New in Nutils 6 &quot;garak-guksu&quot;.</a></h1>
<ul>
<li><a href="https://github.com/evalf/nutils/releases/tag/v6.3">Nutils 6.3</a> was released on November 18th, 2021</li>
<li><a href="https://github.com/evalf/nutils/releases/tag/v6.2">Nutils 6.2</a> was released on October 7th, 2020</li>
<li><a href="https://github.com/evalf/nutils/releases/tag/v6.1">Nutils 6.1</a> was released on July 17th, 2020</li>
<li><a href="https://github.com/evalf/nutils/releases/tag/v6.0">Nutils 6.0</a> was released on April 29th, 2020</li>
</ul>
<h2 id="sparse-module"><a class="header" href="#sparse-module">Sparse module</a></h2>
<p>The new <code>nutils.sparse</code> module introduces a data type and a suite of
manipulation methods for arbitrary dimensional sparse data. The existing
integrate and integral methods now create data of this type under the hood, and
then convert it to a scalar, Numpy array or <code>nutils.matrix.Matrix</code> upon return.
To prevent this conversion and receive the sparse objects instead use the new
<code>nutils.sample.Sample.integrate_sparse</code> or
<code>nutils.sample.eval_integrals_sparse</code>.</p>
<h2 id="external-dependency-for-parsing-gmsh-files"><a class="header" href="#external-dependency-for-parsing-gmsh-files">External dependency for parsing gmsh files</a></h2>
<p>The <code>nutils.mesh.gmsh</code> method now depends on the external
<a href="https://github.com/nschloe/meshio">meshio</a> module to parse .msh files:</p>
<pre><code class="language-sh">python3 -m pip install --user --upgrade meshio
</code></pre>
<h2 id="change-dof-order-in-basisvector"><a class="header" href="#change-dof-order-in-basisvector">Change dof order in basis.vector</a></h2>
<p>When creating a vector basis using <code>topo.basis(..).vector(nd)</code>, the order of
the degrees of freedom changed from grouping by vector components to grouping
by scalar basis functions:</p>
<pre><code>[b0,  0]         [b0,  0]
[b1,  0]         [ 0, b0]
[.., ..] old     [b1,  0]
[bn,  0] ------&gt; [ 0, b1]
[ 0, b0]     new [.., ..]
[.., ..]         [bn,  0]
[ 0, bn]         [ 0, bn]
</code></pre>
<p>This should not affect applications unless the solution vector is manipulated
directly, such as might happen in unit tests. If required for legacy purposes
the old vector can be retrieved using <code>old = new.reshape(-1,nd).T.ravel()</code>.
Note that the change does not extend to <code>nutils.function.vectorize</code>.</p>
<h2 id="change-from-stickybar-to-bottombar"><a class="header" href="#change-from-stickybar-to-bottombar">Change from stickybar to bottombar</a></h2>
<p>For <code>nutils.cli.run</code> to draw a status bar, it now requires the external
<a href="https://github.com/evalf/bottombar">bottombar</a> module to be installed:</p>
<pre><code class="language-sh">python3 -m pip install --user bottombar
</code></pre>
<p>This replaces stickybar, which is no longer used. In addition to the log uri
and runtime the status bar will now show the current memory usage, if that
information is available. On Windows this requires <code>psutil</code> to be installed; on
Linux and OSX it should work by default.</p>
<h2 id="support-for-gmsh-msh4-file-format"><a class="header" href="#support-for-gmsh-msh4-file-format">Support for gmsh 'msh4' file format</a></h2>
<p>The <code>nutils.mesh.gmsh</code> method now supports input in the 'msh4' file format, in
addition to the 'msh2' format which remains supported for backward
compatibility. Internally, <code>nutils.mesh.parsegmsh</code> now takes file contents
instead of a file name.</p>
<h2 id="new-command-line-option-gracefulexit"><a class="header" href="#new-command-line-option-gracefulexit">New command line option: gracefulexit</a></h2>
<p>The new boolean command line option <code>gracefulexit</code> determines what happens when
an exception reaches <code>nutils.cli.run</code>. If true (default) then the exception is
handled as before and a system exit is initiated with an exit code of 2. If
false then the exception is reraised as-is. This is useful in particular when
combined with an external debugging tool.</p>
<h2 id="log-tracebacks-at-debug-level"><a class="header" href="#log-tracebacks-at-debug-level">Log tracebacks at debug level</a></h2>
<p>The way exceptions are handled by <code>nutils.cli.run</code> is changed from logging the
entire exception and traceback as a single error message, to logging the
exceptions as errors and tracebacks as debug messages. Additionally, the order
of exceptions and traceback is fully reversed, such that the most relevant
message is the first thing shown and context follows.</p>
<h2 id="solve-leniently-to-relative-tolerance-in-newton-systems"><a class="header" href="#solve-leniently-to-relative-tolerance-in-newton-systems">Solve leniently to relative tolerance in Newton systems</a></h2>
<p>The <code>nutils.solver.newton</code> method now sets the relative tolerance of the linear
system to <code>1e-3</code> unless otherwise specified via <code>linrtol</code>. This is mainly
useful for iterative solvers which can save computational effort by having
their stopping criterion follow the current Newton residual, but it may also
help with direct solvers to warn of ill conditioning issues. Iterations
furthermore use <code>nutils.matrix.Matrix.solve_leniently</code>, thus proceeding after
warning that tolerances have not been met in the hope that Newton convergence
might be attained regardless.</p>
<h2 id="linear-solver-arguments"><a class="header" href="#linear-solver-arguments">Linear solver arguments</a></h2>
<p>The methods <code>nutils.solver.newton</code>, <code>nutils.solver.minimize</code>,
<code>nutils.solver.pseudotime</code>, <code>nutils.solver.solve_linear</code> and
<code>nutils.solver.optimize</code> now receive linear solver arguments as keyword
arguments rather than via the <code>solveargs</code> dictionary, which is deprecated. To
avoid name clashes with the remaining arguments, argument names must be
prefixed by <code>lin</code>:</p>
<pre><code class="language-python">solver.solve_linear('lhs', res,
  solveargs=dict(solver='gmres')) # deprecated syntax

solver.solve_linear('lhs', res,
  linsolver='gmres') # new syntax
</code></pre>
<h2 id="iterative-refinement"><a class="header" href="#iterative-refinement">Iterative refinement</a></h2>
<p>Direct solvers enter an iterative refinement loop in case the first pass did
not meet the configured tolerance. In machine precision mode (atol=0, rtol=0)
this refinement continues until the residual stagnates.</p>
<h2 id="matrix-solver-tolerances"><a class="header" href="#matrix-solver-tolerances">Matrix solver tolerances</a></h2>
<p>The absolute and/or relative tolerance for solutions of a linear system can now
be specified in <code>nutils.matrix.Matrix.solve</code> via the <code>atol</code> resp. <code>rtol</code>
arguments, regardless of backend and solver. If the backend returns a solution
that violates both tolerances then an exception is raised of type
<code>nutils.matrix.ToleranceNotReached</code>, from which the solution can still be
obtained via the <code>.best</code> attribute. Alternatively the new method
<code>nutils.matrix.Matrix.solve_leniently</code> always returns a solution while logging
a warning if tolerances are not met. In case both tolerances are left at their
default value or zero then solvers are instructed to produce a solution to
machine precision, with subsequent checks disabled.</p>
<h2 id="use-stringly-for-command-line-parsing"><a class="header" href="#use-stringly-for-command-line-parsing">Use stringly for command line parsing</a></h2>
<p>Nutils now depends on stringly (version 1.0b1) for parsing of command line
arguments. The new implementation of <code>nutils.cli.run</code> is fully backwards
compatible, but the preferred method of annotating function arguments is now as
demonstrated in all of the examples.</p>
<p>For new Nutils installations Stringly will be installed automatically as a
dependency. For existing setups it can be installed manually as follows:</p>
<pre><code class="language-sh">python3 -m pip install --user --upgrade stringly
</code></pre>
<h2 id="fixed-and-fallback-lengths-in-namespace-expressions"><a class="header" href="#fixed-and-fallback-lengths-in-namespace-expressions">Fixed and fallback lengths in (namespace) expressions</a></h2>
<p>The <code>nutils.function.Namespace</code> has two new arguments: <code>length_&lt;indices&gt;</code> and
<code>fallback_length</code>. The former can be used to assign fixed lengths to specific
indices in expressions, say index <code>i</code> should have length 2, which is used for
verification and resolving undefined lengths. The latter is used to resolve
remaining undefined lengths:</p>
<pre><code class="language-python">ns = nutils.function.Namespace(length_i=2, fallback_length=3)
ns.eval_ij('δ_ij') # using length_i
# Array&lt;2,2&gt;
ns.eval_jk('δ_jk') # using fallback_length
# Array&lt;3,3&gt;
</code></pre>
<h2 id="treelog-update"><a class="header" href="#treelog-update">Treelog update</a></h2>
<p>Nutils now depends on treelog version 1.0b5, which brings improved iterators
along with other enhancements. For transitional convenience the backwards
incompatible changes have been backported in the <code>nutils.log</code> wrapper, which
now emits a warning in case the deprecated methods are used. This wrapper is
scheduled for deletion prior to the release of version 6.0. To update treelog
to the most recent version use:</p>
<pre><code class="language-sh">python -m pip install -U treelog
</code></pre>
<h2 id="unit-type"><a class="header" href="#unit-type">Unit type</a></h2>
<p>The new <code>nutils.types.unit</code> allows for the creation of a unit system for easy
specification of physical quantities. Used in conjunction with <code>nutils.cli.run</code>
this facilitates specifying units from the command line, as well as providing a
warning mechanism against incompatible units:</p>
<pre><code class="language-python">U = types.unit.create(m=1, s=1, g=1e-3, N='kg*m/s2', Pa='N/m2')
def main(length=U('2m'), F=U('5kN')):
  topo, geom = mesh.rectilinear([numpy.linspace(0,length,10)])
</code></pre>
<pre><code class="language-sh">python myscript.py length=25cm # OK
python myscript.py F=10Pa # error!
</code></pre>
<h2 id="sample-basis"><a class="header" href="#sample-basis">Sample basis</a></h2>
<p>Samples now provide a <code>nutils.sample.Sample.basis</code>: an array that for any point
in the sample evaluates to the unit vector corresponding to its index. This new
underpinning of <code>nutils.sample.Sample.asfunction</code> opens the way for sampled
arguments, as demonstrated in the last example below:</p>
<pre><code class="language-python">H1 = mysample.asfunction(mydata) # mysample.eval(H1) == mydata
H2 = mysample.basis().dot(mydata) # mysample.eval(H2) == mydata
ns.Hbasis = mysample.basis()
H3 = 'Hbasis_n ?d_n' @ ns # mysample.eval(H3, d=mydata) == mydata
</code></pre>
<h2 id="higher-order-gmsh-geometries"><a class="header" href="#higher-order-gmsh-geometries">Higher order gmsh geometries</a></h2>
<p>Gmsh element support has been extended to include cubic and quartic meshes in
2D and quadratic meshes in 3D, and parsing the msh file is now a cacheable
operation. Additionally, tetrahedra now define bezier points at any order.</p>
<h2 id="repository-location"><a class="header" href="#repository-location">Repository location</a></h2>
<p>The Nutils repository has moved to <a href="https://github.com/evalf/nutils.git">https://github.com/evalf/nutils.git</a>. For the
time being the old address is maintained by Github as an alias, but in the long
term you are advised to update your remote as follows:</p>
<pre><code class="language-sh">git remote set-url origin https://github.com/evalf/nutils.git
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../whatsnew/v7.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../whatsnew/v5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../whatsnew/v7.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../whatsnew/v5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
